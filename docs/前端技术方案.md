# 前端技术方案

## 1. 总体原则
- 统一采用 Vue3 + Vite + TypeScript 构建，Composition API 编写组件。
- 三个端（演讲者、观众、后台）物理独立项目，逻辑共享基础组件与工具库。
- 观众端采用移动优先设计，确保二维码扫码进入后在手机浏览器中获得最佳体验。
- UI 设计遵循响应式布局，保证桌面端与移动端浏览体验一致。
- 所有文案、注释、交互提示使用中文，并提供 i18n 扩展能力。

## 2. 项目结构
建议通过 Monorepo（如 pnpm workspace）管理三端项目与共享库：
```
front-end/
  packages/
    shared-ui/         # 共享组件库（按钮、弹窗、卡片等）
    shared-utils/      # 工具函数（WebSocket SDK、语言配置、日期格式化、二维码渲染）
  apps/
    speaker-web/
    viewer-web/
    admin-web/
```
- 构建工具：Vite + pnpm，支持按需编译与热更新。
- 代码规范：ESLint + Prettier + Stylelint，统一风格。
- 测试框架：Vitest + Testing Library（基础单元测试）。
- UI 组件库已确定采用 Naive UI，`shared-ui` 内需抽象主题变量与通用样式，后续设计稿补齐时可直接映射；在缺少 Figma 规范阶段以 Naive 默认样式迭代并逐步沉淀设计约束。

## 3. WebSocket 客户端 SDK
在 `shared-utils` 内建立统一的 WebSocket SDK：
- 封装连接、心跳、自动重连、事件订阅。
- 消息类型：`AUTH`、`AUDIO_CHUNK`、`SUBTITLE`、`PING/PONG` 等。
- 暴露 Promise 化的 `connect(token)`、`sendAudio(chunk)`、`subscribe(lang, handler)` API。
- 处理移动端页面切后台时的连接暂停与恢复。

## 4. 全局状态与数据缓存
- 实时状态（录音面板、连接状态、字幕队列等）统一由 Pinia 管理，遵循模块化 store，确保组件解耦。
- 服务端数据（活动列表、令牌信息、语言列表等）统一使用 TanStack Query（Vue Query）接入，启用请求缓存、后台刷新、失败重试与并发请求去重。
- 通过 `@tanstack/vue-query-persist-client` 搭配 IndexedDB 持久化关键查询（如活动概览、最新字幕历史），满足弱网与离线查看需求。

## 5. 演讲者端（speaker-web）
### 5.1 核心页面与组件
- `ActivitySelector`：展示可参加的活动列表。
- `LanguagePicker`：输入语种选择（受后台配置限制）。
- `RecorderPanel`：麦克风权限申请、音量动画、推流令牌录入以及开始/停止按钮；演讲者需手动输入管理员分发的 UUID 才能建立 WebSocket。
- `SubtitleDisplay`：原文与译文列表，支持滚动。
- `ConnectionStatus`：实时展示网络状态、翻译状态。

### 5.2 音频采集与编码
- 使用 MediaDevices.getUserMedia 获取麦克风音频，优先开启浏览器原生 `autoGainControl`、`noiseSuppression` 能力。
- Web Audio API + Web Worker 对音频进行采样与编码，固定产出 LINEAR16（PCM 16bit, 16kHz），支持按需引入第三方编解码或降噪库，但需控制包体与延迟。
- 默认将音频切分为 120-160ms 的帧（约 3.8-5KB/帧），在实时性与长时稳定性之间取得折中；帧头包含序列号与时间戳，便于后端重排与断线续传。网络良好且需要更低延迟时可临时切至 120ms，网络抖动或后端压力较大时回落至 160ms。
- Worker 内部允许合并多帧批量写入 WebSocket，降低 `postMessage` 频率；若后端提示重连，可缓存 1-2 秒音频数据用于补偿。
- 音频以 120-160ms 帧为单位通过 WebSocket `binary` 发送，注意序列号与重传策略。
- 在移动端提示用户保持页面常亮、避免切换 App 中断录音。

### 5.3 状态管理
- 使用 Pinia 管理全局状态：当前活动、输入语种、连接状态、字幕队列。
- 对原文与译文分开存储，方便前端渲染。
- 推流令牌以活动维度持久化至 localStorage，并在状态层暴露最近更新时间，确保未录入令牌时禁用推流按钮。
- 当前实现：完成 `speaker-web` 控制台首屏（活动选择、音频采集、字幕流、连接健康、演讲提醒与支撑卡片），引入 Naive UI 的定制主题与多层卡片样式；通过 TanStack Query + Mock Service 提供实时数据占位，并在 Pinia 中维护音量、连接与字幕序列逻辑。
- 待办事项：接入真实 WebSocket SDK、将活动与字幕数据替换为 `/api/v1` 接口，补充彩排录音流程与权限校验；按设计规范完善响应式断点的动画与触控反馈；补齐 Vitest 组件用例（当前跑测试需加 `--passWithNoTests` 或新增 `*.spec.ts`）。

## 6. 观众端（viewer-web）
### 6.1 核心页面
- `JoinPage`：扫码进入后显示加载状态，若直接访问可输入邀请码。
- `LanguageSelector`：选择目标语言，下拉或标签形式展示主流语言。
- `LiveSubtitle`：实时字幕流，自动滚动，并高亮最新句子。
- `HistoryPanel`：展示最近 5 分钟字幕，提供向上滚动加载历史。
- `ConnectionIndicator`：网络状态与重连提示。

### 6.2 字幕渲染策略
- 使用虚拟列表优化大量字幕渲染。
- 新字幕到达时若用户停留在底部则自动滚动，否则显示“有新字幕”的提示。
- 字幕数据结构 `{id, content, timestamp, lang}`。
- 通过 IndexedDB 持久化最近字幕，配合 TanStack Query 的持久化能力保障离线临时查看。

### 6.3 移动端适配
- 使用移动优先的 CSS Grid/Flex 布局，自适应横竖屏。
- 预设合理的默认字体大小与间距，保证手机端可读性。
- 提供字体大小调节、夜间模式等增强可读性选项（可放入后续迭代）。
- 针对二维码扫码场景，支持一键切换语言、返回历史字幕。

## 7. 后台端（admin-web）
### 7.1 核心模块
- `Auth`：管理员登录、Logout，支持短会话 + Refresh Token；Access Token 默认 15 分钟，前端检测即将过期时调用刷新接口，实现无感续期并降低凭据泄露风险，如业务接受更长会话可在后续迭代调整配置。
- `ActivityList`、`ActivityEditor`：活动 CRUD，表单校验、图片上传（调用后端对象存储接口）。
- `ActivitySuccess`：活动创建成功页，展示观众端二维码、分享链接、下载按钮。
- `TokenManagement`：生成演讲者/观众令牌，显示有效期、状态；支持撤销单个演讲者令牌或一键撤销全部演讲者令牌，并在列表中提供复制、撤销等快捷操作。
- `QrCenter`：在活动详情中显示当前二维码状态，支持失效操作（活动结束后默认失效，可手动重新激活）。
- `Dashboard`：展示观众数、语种分布（预留，初期可提供空状态）。

### 7.2 表单与验证
- 组件库统一使用 Naive UI，结合 VeeValidate 进行表单校验。
- 上传图片时先压缩（如 browser-image-compression），再调用后端接口。
- 活动成功创建后自动跳转到 `ActivitySuccess`，强调下载二维码或复制链接。

### 7.3 二维码显示与下载
- 后端返回 PNG/Base64，前端通过 `<img>` 渲染，并提供“下载 PNG”“复制链接”按钮。
- 若二维码生成失败，提示管理员刷新或使用纯链接复制。
- 失效操作（活动关闭、管理员手动）后刷新界面，显示“二维码已失效”并提供重新启用选项。

## 8. 国际化与语言列表
- 使用 Vue I18n 管理 UI 文案。
- 语言列表来自后端配置，通过 API 拉取缓存。
- 观众端选择语言后写入本地存储，方便刷新后维持选择。

## 9. 错误处理与反馈
- 全局 Axios 拦截器处理 REST API 错误。
- WebSocket 断开时展示 Toast，支持手动重连。
- 对 Google API 或后端异常，给出用户友好的提示文字，避免技术细节暴露。
- 二维码生成失败时展示备用链接与复制按钮。

## 10. 构建与部署
- 环境变量通过 `.env.[mode]` 管理，例如 `VITE_API_BASE_URL`、`VITE_WS_URL`、`VITE_VIEWER_BASE_URL`。
- 构建命令：`pnpm build`，输出静态资源。
- 部署方式：
  - 初期：将构建产物复制到 Nginx 静态目录。
  - 后续：托管至 S3 + CloudFront，后端仅提供 API 与 WebSocket。
- 当前阶段默认单环境部署，无需区分 dev/staging/prod，可通过 `.env` 直接注入 Nginx 对接的 API/WS 地址；待多环境需求明确后再拆分配置。
- 前端预览说明：开发调试使用 `pnpm --filter @orion/speaker-web dev`；构建后通过 `pnpm --filter @orion/speaker-web preview` 或其他静态服务器加载 `apps/speaker-web/dist/`，避免直接以 `file://` 打开导致资源路径解析异常。

## 11. 测试策略
- 单元测试：关键组件、工具函数。
- 端到端测试：使用 Cypress 覆盖核心流程（演讲者推流、观众收字幕、后台 CRUD、二维码下载/失效）。
- 移动端适配测试：Chrome DevTools + 真机抽测，详细规划待后续阶段启动。

## 12. 性能优化
- 懒加载路由与组件，降低首屏体积。
- 使用 PWA 插件提供离线提示与缓存基础资源（可选）。
- 观众端使用 requestAnimationFrame 控制字幕更新，避免大量 DOM reflow。
- 后台二维码页面采用延迟加载，避免在列表中批量生成造成卡顿。

## 13. 安全考虑
- 所有 API 请求附带身份令牌，前端只存储短期 Token。
- 避免在前端直接暴露任何 Google API Key。
- 使用 CSP（Content Security Policy）与 HTTPS 确保资源安全。
- 二维码链接与活动状态绑定，活动关闭时前端提示二维码已失效。
