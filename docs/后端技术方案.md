# 后端技术方案

## 1. 技术选型与架构
- 编程语言：Go（1.20+）。
- Web 框架：Gin，用于 REST API 与 WebSocket。
- WebSocket：Gorilla WebSocket，实现可靠的连接管理与消息编解码。
- 配置管理：Viper，支持多环境与热加载（可选）。
- 依赖注入：Wire（可选）或手写构造函数，保持模块化。
- 日志：Zap，结构化输出。
- 测试：GoConvey 或 testify，覆盖单元与集成测试。

架构层次：
- **接口层**：HTTP 路由、协议解析、认证中间件。
- **应用层**：处理业务流程（活动管理、翻译管线、字幕广播、二维码管理）。
- **领域层**：定义实体与领域服务。
- **基础设施层**：与 Google API、缓存、存储、二维码生成器交互。

## 2. 模块划分
### 2.1 活动管理模块
- 实体：`Activity`（id、title、description、speaker、startTime、languages、status、coverUrl、viewerUrl）。
- 服务：活动 CRUD、状态变更（draft/published/closed）、默认语言配置、活动成功创建后的二维码生成。
- 存储：初期可使用内存/文件，预留接口对接数据库（PostgreSQL）。

### 2.2 鉴权模块
- 管理员登录：账号密码 + JWT，JWT 过期时间 2 小时，Refresh Token 7 天。
- 演讲者/观众令牌：后台生成一次性 JWT，包含活动 ID、角色、有效期（1-2 小时）。
- 中间件：解析 Authorization 头或 WebSocket 握手参数，校验角色与活动权限。

### 2.3 实时翻译模块
- 管理 WebSocket 会话：
  - 演讲者连接：创建 `SessionManager`，负责保存 STT 流、翻译结果队列。
  - 观众连接：按语言订阅频道。
- 音频管线：
  - `AudioIngestor`：接收音频块，写入 `chan []byte`。
  - `STTClient`：使用 Google Streaming API，监听识别结果。
  - `TranslationClient`：对 final 文本调用 Translation API，生成多语言结果。
  - `SubtitleDispatcher`：按语言广播到观众连接。
- 历史缓存：使用 Redis 或内存 RingBuffer 保存最近 5 分钟字幕，支持观众查询。

### 2.4 文件与资源模块
- 接口：上传封面图片，返回 CDN URL。
- 实现：初期可保存至本地文件系统（挂载卷），后续接入 AWS S3。

### 2.5 二维码模块
- 功能：为每个活动生成观众端访问链接对应的二维码，供后台展示与下载。
- 实现：
  - 链接格式：`{viewerBaseUrl}/activity/{activityId}?code={inviteCode}`。
  - 使用 `github.com/skip2/go-qrcode` 等库生成 PNG 或 SVG，返回 Base64 编码供前端渲染。
  - 活动创建成功时自动生成二维码；活动关闭或手动失效时更新状态。
  - 无需短链或额外分发服务，保持实现简洁。

## 3. WebSocket 设计
### 3.1 握手流程
1. 前端携带 `token` 参数与 `activityId` 请求 `/ws/speaker` 或 `/ws/viewer`。
2. 后端验证令牌（角色、活动状态、过期时间）。
3. 成功后返回连接成功消息，并发送语言配置。

### 3.2 消息规范
- 演讲者端 → 后端：
  - `AUTH`：`{"type":"AUTH","payload":{"lang":"zh-CN"}}`
  - `AUDIO`：二进制帧或 Base64 JSON。
  - `CONTROL`：开始/结束。
- 后端 → 观众端：
  - `SUBTITLE`：`{"type":"SUBTITLE","payload":{"sentenceId":"uuid","lang":"en","text":"...","timestamp":1680000000}}`
  - `HISTORY`：初始发送最近 N 条。
  - `STATE`：错误提示、重连引导。

### 3.3 心跳与重连
- 后端每 30 秒发送 `PING`，客户端响应 `PONG`。
- 若 3 次心跳无响应则断开，并通知应用层。
- 支持客户端重连机制，重新发送 `AUTH` 与 `lang` 信息。

## 4. Google API 集成
### 4.1 Speech-to-Text
- 使用 StreamingRecognize：
  - 设置语言（演讲者输入语种）。
  - 配置 `enableAutomaticPunctuation=true` 以获得完整句子。
  - 监听 `isFinal` 标志，只有 Final 结果才进入翻译流程。
- 音频规格：编码 `LINEAR16` 或 `OGG_OPUS`，采样率 16000 Hz。

### 4.2 Translation API
- 调用 `TranslateText`，目标语言列表由后台配置。
- 可提前批量获取语言支持列表，缓存在后端。
- 错误处理：捕获 quota exceeded、网络异常，重试 3 次后提示客户端。

### 4.3 凭证管理
- 使用服务账户 JSON，存储于 EC2 安全目录或 Secrets Manager。
- 通过环境变量 `GOOGLE_APPLICATION_CREDENTIALS` 指向凭证路径。

## 5. 配置管理
- 配置项：服务器端口、JWT 密钥、Google API 项目 ID、Redis 地址、活动缓存策略、观众端基础 URL 等。
- 使用 Viper 读取 `config.yaml`，支持环境变量覆盖。

## 6. 日志与监控
- 日志包含：请求 ID、活动 ID、用户角色、错误栈、二维码生成与失效操作。
- 使用 Zap 输出 JSON 结构，方便后续接入 ELK/CloudWatch。
- 指标：翻译成功率、STT 耗时、Translation 耗时、WebSocket 连接数、二维码生成次数。

## 7. 错误处理
- 统一错误码：包括鉴权失败、活动关闭、配额不足、翻译失败、二维码生成失败等。
- REST API 返回 `{code, message, data}` 格式。
- WebSocket 发送 `STATE` 消息通知前端。

## 8. 测试策略
- 单元测试：活动管理、令牌生成、配置加载、消息序列化、二维码生成。
- 集成测试：模拟 WebSocket 连接、Google API Mock、二维码接口测试。
- 性能测试：使用 k6/siege 对 WebSocket 与 REST API 进行压力测试。

## 9. 未来扩展
- 引入消息队列（Kafka/NATS）实现解耦。
- 将活动、字幕、用户落库至数据库，支持分析与回溯。
- 支持多实例部署，通过 Redis Pub/Sub 或 NATS 同步字幕。
- 后续如需短链、短信推送、批量导出二维码等高级功能，可在该模块基础上扩展。
