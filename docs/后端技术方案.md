# 后端技术方案

## 1. 技术选型与架构
- 编程语言：Go（当前使用 1.25.x）。
- Web 框架：Gin，用于 REST API 与 WebSocket。
- WebSocket：Gorilla WebSocket，实现可靠的连接管理与消息编解码。
- 配置管理：通过环境变量加载（`internal/infra/config`），后续可视情况接入 Viper 等配置中心。
- 依赖注入：阶段性采用手写构造函数，保留后续接入 Wire 等工具的空间。
- 日志：暂使用标准库 `log`，计划升级为结构化日志（Zap/zerolog）。
- 测试：尚未铺设自动化测试，需要逐步补齐单元与集成覆盖。

架构层次：
- **接口层**：HTTP 路由、协议解析、认证中间件。
- **应用层**：处理业务流程（活动管理、翻译管线、字幕广播、二维码管理）。
- **领域层**：定义实体与领域服务。
- **基础设施层**：与 Google API、缓存、存储、二维码生成器交互。

## 2. 模块划分
### 2.1 活动管理模块
- 实体：`Activity`（id、title、description、speaker、startTime、languages、status、coverUrl、viewerUrl）。
- 服务：活动 CRUD、状态变更（draft/published/closed）、默认语言配置、生成默认观众访问链接。
- 存储：已经切换至 PostgreSQL（开发环境默认 `postgres://orion@localhost:5432/orion_dev`），配套迁移脚本自动创建 `activities`、`activity_tokens`、`viewer_entries` 表；计划以 PostgreSQL 为真实数据源、Redis 作为热点缓存。

### 2.2 访问控制模块
- 服务：`AccessService` 负责演讲者令牌、观众邀请码与观众入口状态管理，底层使用 PostgreSQL 仓储持久化 `activity_tokens` 与 `viewer_entries`。
- 能力：
  - 生成演讲者令牌（UUID，默认有效期 24 小时），用于 WebSocket 鉴权；支持撤销单个令牌或批量撤销活动下的所有令牌，撤销后状态从 `active` 变为 `revoked`。
  - 生成观众邀请码（支持配置 `ttlMinutes` 和 `maxAudience`），自动撤销旧邀请码并更新观众入口信息。
  - 提供观众入口查询/启用/撤销接口，返回分享链接及二维码数据。

### 2.3 鉴权模块
- 管理员登录：账号密码 + JWT，当前采用 HS256，本地密钥来自 `JWT_SECRET_PATH` 文件；访问令牌默认 15 分钟，Refresh Token 默认 7 天，可通过环境变量调整。
- 演讲者/观众令牌：后台生成一次性字符串令牌（存储于 PostgreSQL），包含活动 ID、类型、有效期；演讲者令牌需由管理员分发，前端不再自动生成。
- 中间件：解析 Authorization 头校验管理员身份；WebSocket 鉴权依赖演讲者/观众令牌，按活动和语言校验后方可建立连接。

### 2.4 实时翻译模块
- 管理 WebSocket 会话：
  - 演讲者连接：创建 `SessionManager`，负责保存 STT 流、翻译结果队列。
  - 观众连接：按语言订阅频道。
- 音频管线：
  - `AudioIngestor`：接收音频块，写入 `chan []byte`。
  - `STTClient`：使用 Google Streaming API，监听识别结果。
  - `TranslationClient`：对 final 文本调用 Translation API，生成多语言结果。
  - `SubtitleDispatcher`：按语言广播到观众连接。
- 历史缓存：使用 Redis 或内存 RingBuffer 保存最近 5 分钟字幕，支持观众查询。

### 2.5 文件与资源模块
- 接口：上传封面图片（`POST /uploads/cover`）。
- 当前实现：占位接口，返回 501 提示尚未接入对象存储。
- 规划：接入本地文件系统或 S3/OSS，并返回可访问的 CDN URL。

### 2.6 二维码模块
- 功能：为每个活动生成观众端访问链接，对应观众入口二维码。
- 当前实现：生成分享链接，并以 `data:text/plain;base64,...` 的形式返回占位 QR 数据（前端可先使用文本内容渲染）。
- 规划：接入二维码图片生成库（如 `github.com/skip2/go-qrcode`），并在启用/撤销操作时更新缓存。

## 3. WebSocket 设计
### 3.1 握手流程
1. 前端携带 `token` 参数与 `activityId` 请求 `/ws/speaker` 或 `/ws/viewer`。
2. 后端验证令牌（角色、活动状态、过期时间）。
3. 成功后返回连接成功消息，并发送语言配置。

### 3.2 消息规范
- 演讲者端 → 后端：
  - `AUTH`：`{"type":"AUTH","payload":{"lang":"zh-CN"}}`
  - `AUDIO`：二进制帧或 Base64 JSON。
  - `CONTROL`：开始/结束。
- 后端 → 观众端：
  - `SUBTITLE`：`{"type":"SUBTITLE","payload":{"sentenceId":"uuid","lang":"en","text":"...","timestamp":1680000000}}`
  - `HISTORY`：初始发送最近 N 条。
  - `STATE`：错误提示、重连引导。

### 3.3 心跳与重连
- 后端每 30 秒发送 `PING`，客户端响应 `PONG`。
- 若 3 次心跳无响应则断开，并通知应用层。
- 支持客户端重连机制，重新发送 `AUTH` 与 `lang` 信息。

## 4. Google API 集成
### 4.1 Speech-to-Text
- 使用 StreamingRecognize：
  - 设置语言（演讲者输入语种）。
  - 配置 `enableAutomaticPunctuation=true` 以获得完整句子。
  - 监听 `isFinal` 标志，只有 Final 结果才进入翻译流程。
- 音频规格：编码 `LINEAR16` 或 `OGG_OPUS`，采样率 16000 Hz。

### 4.2 Translation API
- 调用 `TranslateText`，目标语言列表由后台配置。
- 可提前批量获取语言支持列表，缓存在后端。
- 错误处理：捕获 quota exceeded、网络异常，重试 3 次后提示客户端。

### 4.3 凭证管理
- 使用服务账户 JSON，存储于 EC2 安全目录或 Secrets Manager。
- 通过环境变量 `GOOGLE_APPLICATION_CREDENTIALS` 指向凭证路径。

## 5. 配置管理
- 配置项：服务器端口、管理员账号密码、JWT 密钥、Token TTL、Google API 凭证路径、Redis 地址（预留）、观众端基础 URL 等。
- 现状：通过 `internal/infra/config` 从环境变量加载，并提供默认值；对端口、账号、Token TTL 等关键参数做校验。
- 规划：后续可接入 Viper/文件配置或远程配置中心，提高多环境管理能力。

## 6. 日志与监控
- 日志：当前基于标准库 `log` 输出，记录服务启动、管线事件、令牌生成等信息；计划引入结构化日志并补充请求 ID。
- 指标规划：翻译成功率、STT/Translation 调用耗时、WebSocket 连接数、二维码生成次数等，可在接入 Prometheus 后落地。

## 7. 错误处理
- 统一错误码：包括鉴权失败、活动关闭、配额不足、翻译失败、二维码生成失败等。
- REST API 返回 `{code, message, data}` 格式。
- WebSocket 发送 `STATE` 消息通知前端。

## 8. 测试策略
- 单元测试：活动管理、令牌生成、配置加载、消息序列化、二维码生成。
- 集成测试：模拟 WebSocket 连接、Google API Mock、二维码接口测试。
- 性能测试：使用 k6/siege 对 WebSocket 与 REST API 进行压力测试。

## 9. 未来扩展
- 引入消息队列（Kafka/NATS）实现解耦。
- 将活动、字幕、用户落库至数据库，支持分析与回溯。
- 支持多实例部署，通过 Redis Pub/Sub 或 NATS 同步字幕。
- 后续如需短链、短信推送、批量导出二维码等高级功能，可在该模块基础上扩展。
